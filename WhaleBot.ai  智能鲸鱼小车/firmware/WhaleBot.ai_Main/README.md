# 🐋 WhaleBot.ai 固件说明 (WhaleBot.ai_Main)

本文档详细说明了 WhaleBot 智能鲸鱼小车主控程序（`WhaleBot.ai_Main.ino`）的编译环境配置、依赖库安装及代码逻辑。

## 🛠️ 1. 开发环境配置 (Arduino IDE)

本项目基于 **ESP32-S3** 芯片开发，为了确保程序能正常运行（特别是录音和长文本处理），**必须**正确配置 PSRAM。

### 1.1 安装开发板支持包
*   打开 Arduino IDE -> `文件` -> `首选项`。
*   在“附加开发板管理器网址”中添加：
    `https://espressif.github.io/arduino-esp32/package_esp32_index.json`
*   点击 `工具` -> `开发板` -> `开发板管理器`，搜索 **ESP32 by Espressif System** 并安装 (推荐版本 3.3.5)。

### 1.2 关键参数配置 (至关重要 ⚠️)
请按照以下步骤配置 `工具 (Tools)` 菜单：

1.  **开发板 (Board)**: 选择 `ESP32S3 Dev Module`。
2.  **USB CDC On Boot**: 选择 `Enabled` (这样串口监视器才能看到打印信息)。
3.  **Flash Mode**: 选择 `QIO 80MHz`。
4.  **PSRAM**: **必须选择 `OPI PSRAM`**。
    *   *解释*：本项目录音缓存和 Base64 编码需要大量内存，内部 SRAM 不够用，必须开启外部 8MB PSRAM。
    *   *注意*：开启 OPI PSRAM 后，GPIO 35, 36, 37 将被占用，不可用于其他功能（代码中已避开这些引脚）。

---

## 📚 2. 依赖库安装

在编译代码前，请在 Arduino IDE 的 `项目` -> `加载库` -> `管理库` 中搜索并安装以下第三方库：

*   **ArduinoJson** (必选)
    *   说明：用于解析 Coze 大模型和百度 API 返回的 JSON 数据。
    *   版本：推荐 6.x 版本。
*   **UrlEncode** (必选)
    *   说明：用于将中文文本转换为 URL 编码格式，以便发送 HTTP 请求。

*注：`HTTPClient`, `WiFi`, `driver/i2s` 等库包含在 ESP32 开发板包中，无需单独下载。*

---

## 🔌 3. 硬件引脚速查表 (Pinout)

如果在画 PCB 或连线时需要参考，请以本表为准（与代码定义一致）。

### 3.1 外部接口 (串口通信)
用于连接天问 ASR 或蓝牙模块：
*   **TX (模块端)** -> 接 ESP32 **GPIO 18** (RX)
*   **RX (模块端)** -> 接 ESP32 **GPIO 17** (TX)

### 3.2 音频系统 (I2S)

**麦克风 (INMP441)**
*   **SCK** (时钟) -> **GPIO 4**
*   **WS** (字选) -> **GPIO 5**
*   **SD** (数据) -> **GPIO 6**

**功放 (MAX98357A)**
*   **BCLK** (位时钟) -> **GPIO 8** (*注意：此处非默认的15*)
*   **LRC** (左右声道) -> **GPIO 16**
*   **DIN** (数据入) -> **GPIO 7**

### 3.3 电机驱动 (TB6612 x2)

**左前轮 (FL)**
*   IN1: **42**
*   IN2: **41**
*   PWM: **40**

**右前轮 (FR)**
*   IN1: **39**
*   IN2: **38**
*   PWM: **48** (*注意：避开了 OPI PSRAM 引脚*)

**左后轮 (RL)**
*   IN1: **10**
*   IN2: **11**
*   PWM: **12**

**右后轮 (RR)**
*   IN1: **13**
*   IN2: **14**
*   PWM: **21**

---

## 🧠 4. 代码逻辑架构

本固件采用 **状态机 (State Machine)** 架构，确保小车在不同模式下互不干扰。

### 4.1 核心状态
1.  **MODE_IDLE (待机)**
    *   停止所有电机和录音，仅监听串口指令。
    *   收到 `停止` 指令后强制回到此状态。
2.  **MODE_VOICE (语音)**
    *   进入后等待 `开始聊天` 指令触发。
    *   **流程**：VAD 录音 (说话即录，说完即停) -> 回放录音 -> 百度 STT (转文字) -> Coze LLM (AI思考) -> 百度 TTS (语音合成并播放)。
3.  **MODE_MOTION (运动)**
    *   接收串口 `W/A/S/D` 等指令控制麦克纳姆轮全向移动。
    *   支持 `点动模式` (动2秒自动停) 和 `持续模式` (一直动直到停止)。

### 4.2 串口通信协议
*   **波特率**: `115200`
*   **结束符**: 每一条指令必须以换行符 `\n` 结尾。
*   **指令示例**:
    *   `打开对话模式` —— 进入语音状态
    *   `开始聊天` —— 触发录音
    *   `W` —— 前进
    *   `停止` —— 全局急停

---

## 📝 5. 使用前必读

在上传代码前，请务必在 `WhaleBot.ai_Main.ino` 文件的顶部 **用户配置区** 填入你自己的信息：

1.  **WiFi**: 修改 SSID 和 密码。
2.  **百度智能云**: 填入 API Key 和 Secret Key (用于语音服务)。
3.  **Coze (扣子)**: 填入 PAT Token 和 Bot ID (用于 AI 对话)。

> 详细的 API 获取教程请查看目录下的：`firmware/百度 和 COZE API获取/Readme.md`
